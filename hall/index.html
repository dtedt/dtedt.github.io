<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Hallway Explorer</title>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <style>
    body { margin: 0; overflow: hidden; touch-action: none; }
    canvas { width: 100%; height: 100%; display: block; }
    #view-label {
      position: absolute; bottom: 20px; left: 50%; 
      transform: translateX(-50%); color: white; 
      font-family: Arial; background: rgba(0,0,0,0.5); 
      padding: 5px 10px; border-radius: 5px;
    }
  </style>
</head>
<body>
  <canvas id="renderCanvas"></canvas>
  <div id="view-label">First-Person View</div>
  <script>
    // Initialize Babylon.js
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);
    const scene = new BABYLON.Scene(engine);
    scene.clearColor = new BABYLON.Color4(0.1, 0.1, 0.15);

    // View label
    const viewLabel = document.getElementById("view-label");

    // --- Camera System ---
    let activeCamera;
    let isTransitioning = false;

    // First-person camera
    const fpsCamera = new BABYLON.UniversalCamera("fpsCamera", new BABYLON.Vector3(0, 1.6, 0), scene);
    fpsCamera.attachControl(canvas, true);
    fpsCamera.applyGravity = false;
    fpsCamera.ellipsoid = new BABYLON.Vector3(0.5, 1.6, 0.5);
    fpsCamera.minZ = 0.1;
    fpsCamera.speed = 0;
    fpsCamera.angularSensibility = 0;

    // God's-eye camera (top-down)
    const godCamera = new BABYLON.ArcRotateCamera("godCamera", -Math.PI/2, Math.PI/2, 15, 
      new BABYLON.Vector3(0, 0, 0), scene);
    godCamera.lowerRadiusLimit = 10;
    godCamera.upperRadiusLimit = 20;
    godCamera.attachControl(canvas, false);
    godCamera.inputs.clear(); // Disable default controls

    // Start in first-person
    activeCamera = fpsCamera;
    scene.activeCamera = fpsCamera;

    // --- Environment ---
    // ... [Keep your existing hallway creation code] ...
    // Create the cross-shaped hallway as before
    const hallwayLength = 10;
    const hallwayWidth = 2;
    const wallHeight = 3;

    function createHallwaySegment(centerX, centerZ, length, width, rotationY) {
      // ... [Your existing hallway segment code] ...
    }

    createHallwaySegment(0, 0, hallwayLength, hallwayWidth, 0); // Horizontal
    createHallwaySegment(0, 0, hallwayLength, hallwayWidth, Math.PI/2); // Vertical

    // --- Input Handling ---
    let touchStartTime = 0;
    let holdTimeout;
    const holdThreshold = 500; // 0.5 seconds to trigger

    canvas.addEventListener("pointerdown", (e) => {
      touchStartTime = Date.now();
      holdTimeout = setTimeout(switchToGodView, holdThreshold);
    }, { passive: true });

    canvas.addEventListener("pointerup", (e) => {
      clearTimeout(holdTimeout);
      if (activeCamera === godCamera && Date.now() - touchStartTime < holdThreshold * 2) {
        switchToFPSView();
      }
    }, { passive: true });

    canvas.addEventListener("pointercancel", () => clearTimeout(holdTimeout));

    // Camera transition functions
    function switchToGodView() {
      if (isTransitioning || activeCamera === godCamera) return;
      
      isTransitioning = true;
      viewLabel.textContent = "God's-Eye View";
      
      // Store FPS position
      godCamera.target = fpsCamera.position.clone();
      godCamera.radius = 15;
      godCamera.alpha = -Math.PI/2;
      godCamera.beta = Math.PI/2;
      
      scene.activeCamera = godCamera;
      activeCamera = godCamera;
      isTransitioning = false;
    }

    function switchToFPSView() {
      if (isTransitioning || activeCamera === fpsCamera) return;
      
      isTransitioning = true;
      viewLabel.textContent = "First-Person View";
      
      // Smooth transition
      BABYLON.Animation.CreateAndStartAnimation(
        "cameraTransition", godCamera, "radius", 
        60, 10, godCamera.radius, 2, 0, 1, () => {
          scene.activeCamera = fpsCamera;
          activeCamera = fpsCamera;
          isTransitioning = false;
        }
      );
    }

    // --- Swipe Controls (FPS only) ---
    // ... [Your existing swipe control code, but wrap in FPS check] ...
    function handleSwipe() {
      if (activeCamera !== fpsCamera) return;
      // ... [Your existing swipe logic] ...
    }

    // Run the engine
    engine.runRenderLoop(() => scene.render());
    window.addEventListener("resize", () => engine.resize());
  </script>
</body>
</html>
